const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const https = require('https');

// --- Config ---
// --- Config ---
const PACKAGE_JSON_PATH = path.join(__dirname, '../package.json');
const VERSION_TS_PATH = path.join(__dirname, '../src/version.ts');
const ENV_PATH = path.join(__dirname, '../.env.local');
const CHANGELOG_PATH = path.join(__dirname, '../../../../CHANGELOG.md'); // Adjust based on repo root

// Load .env.local manually
if (fs.existsSync(ENV_PATH)) {
    const envConfig = fs.readFileSync(ENV_PATH, 'utf8');
    envConfig.split('\n').forEach(line => {
        const [key, value] = line.split('=');
        if (key && value) {
            process.env[key.trim()] = value.trim();
        }
    });
}

const GROQ_API_KEY = process.env.GROQ_API_KEY;

if (!GROQ_API_KEY) {
    console.error("‚ùå Error: GROQ_API_KEY is not set in .env.local or environment variables.");
    process.exit(1);
}

// --- Helpers ---
function run(command) {
    try {
        return execSync(command, { encoding: 'utf8' }).trim();
    } catch (e) {
        return '';
    }
}

async function generateChangelog(commits) {
    console.log("ü§ñ Asking Llama 3 (via Groq) to write changelog...");

    // Fallback if no commits
    if (!commits) return "No significant changes.";

    const prompt = `
You are a cool tech lead for a startup. Summarize these git commits into a concise, readable changelog entry.
Use emojis. Group by Features (‚ú®), Fixes (üêõ), and Improvements (‚ö°Ô∏è).
Ignore 'wip', 'chore', or 'merge' commits unless important.
Keep it punchy and exciting for users.

Commits:
${commits}

Format output as markdown (just the content, no title or markdown block ticks).
`;

    const data = JSON.stringify({
        model: "llama-3.1-8b-instant",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.7,
        max_tokens: 500
    });

    return new Promise((resolve, reject) => {
        const req = https.request({
            hostname: 'api.groq.com',
            path: '/openai/v1/chat/completions',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${GROQ_API_KEY}`
            }
        }, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
                try {
                    const json = JSON.parse(body);
                    resolve(json.choices[0]?.message?.content || "Auto-generated changelog failed.");
                } catch (e) {
                    console.error("Groq Parse Error:", body);
                    resolve("Failed to generate changelog via AI.");
                }
            });
        });

        req.on('error', (e) => {
            console.error("Groq Request Error:", e);
            resolve("Failed to reach Groq API.");
        });

        req.write(data);
        req.end();
    });
}

// --- Main ---
(async () => {
    try {
        console.log("üöÄ Starting Release Process...");

        // 1. Read Package.json
        const pkg = require(PACKAGE_JSON_PATH);
        const currentVersion = pkg.version;
        const [major, minor, patch] = currentVersion.split('.').map(Number);

        // 2. Bump Version
        const newVersion = `${major}.${minor}.${patch + 1}`;
        console.log(`üÜô Bumping version: ${currentVersion} -> ${newVersion}`);

        // 3. Get Commits since last tag (or last 10 if no tags)
        let commits = run(`git log $(git describe --tags --abbrev=0 2>/dev/null)..HEAD --oneline`);
        if (!commits) {
            console.log("‚ö†Ô∏è No tags found, using last 10 commits.");
            commits = run('git log -n 10 --oneline');
        }

        // 4. Generate AI Changelog
        const aiChangelog = await generateChangelog(commits);
        console.log("\nüìù Generated Changelog to Prepend:\n");
        console.log("------------------------------------------------");
        console.log(aiChangelog);
        console.log("------------------------------------------------\n");

        // 5. Update Files

        // package.json
        pkg.version = newVersion;
        fs.writeFileSync(PACKAGE_JSON_PATH, JSON.stringify(pkg, null, 2) + '\n');

        // version.ts
        const versionTsContent = `// This file is auto-generated by the push script. Do not edit manually.\nexport const APP_VERSION = "${newVersion}";\n`;
        fs.writeFileSync(VERSION_TS_PATH, versionTsContent);

        // CHANGELOG.md (Prepend)
        const date = new Date().toISOString().split('T')[0];
        const newEntry = `\n## v${newVersion} (${date})\n\n${aiChangelog}\n\n`;

        // Correct path handling if one level up or root
        let changelogContent = '';
        if (fs.existsSync(CHANGELOG_PATH)) {
            changelogContent = fs.readFileSync(CHANGELOG_PATH, 'utf8');
        }
        fs.writeFileSync(CHANGELOG_PATH, newEntry + changelogContent);

        // 6. Git Operations
        console.log("üì¶ Committing and Pushing...");
        run('git add .');
        run(`git commit -m "chore: release v${newVersion} üöÄ"`);
        run('git push origin main');

        console.log(`\n‚úÖ Successfully released v${newVersion}!`);

        // 7. Deploy Supabase Functions
        console.log("‚ö°Ô∏è Deploying Supabase Edge Functions...");
        try {
            // Use inherit to show live logs (and prove it works without docker)
            execSync('npx supabase functions deploy --no-verify-jwt', { stdio: 'inherit' });
            console.log("‚úÖ Supabase Functions Deployed!");
        } catch (err) {
            console.error("‚ö†Ô∏è Supabase deployment failed (but git push succeeded). Check logs.");
        }

    } catch (e) {
        console.error("\n‚ùå Script Failed:", e);
        process.exit(1);
    }
})();
